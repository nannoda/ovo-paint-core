{
  "version": 3,
  "sources": ["src/submodules/common-ts-utils/WebWorker/CreateWorker.ts", "src/Documents/DocNodes/WorkerLayer.ts", "src/Main.ts"],
  "sourcesContent": ["export function createWorkerFromFunction(workerFunction: () => void): Worker {\n    checkCompatibility();\n    const blob = new Blob(['(' + workerFunction.toString() + ')()'], {type: 'application/javascript'});\n    return new Worker(URL.createObjectURL(blob));\n}\n\nfunction checkCompatibility() {\n    if (window.Worker === undefined) {\n        throw new Error(\"Your browser does not support Web Workers.\");\n    }\n}\n", "import {createWorkerFromFunction} from \"../../submodules/common-ts-utils/WebWorker/CreateWorker\";\n\nfunction layerWorkerCode() {\n    let canvas: OffscreenCanvas;\n    let ctx: OffscreenCanvasRenderingContext2D;\n\n    function drawDot(pos: Vec2) {\n        ctx.fillStyle = \"red\";\n        ctx.beginPath();\n        ctx.arc(pos[0], pos[1], 5, 0, 2 * Math.PI);\n        ctx.fill();\n    }\n\n    function updateBitmap(){\n        let bitmap = canvas.transferToImageBitmap();\n        self.postMessage({\n            key: \"updateBitmap\",\n            data: bitmap,\n        })\n        ctx.drawImage(bitmap, 0, 0)\n    }\n\n    self.onmessage = (e) => {\n        let data = e.data as LayerWorkerEvent;\n        switch (data.key) {\n            case \"setCanvas\":\n                canvas = data.data as OffscreenCanvas;\n                console.log(canvas)\n                ctx = canvas.getContext(\"2d\") as OffscreenCanvasRenderingContext2D;\n                break;\n            case \"drawDot\":\n                ctx.fillStyle = \"red\";\n                ctx.beginPath();\n                ctx.arc(data.data[0], data.data[1], 5, 0, 2 * Math.PI);\n                ctx.fill();\n                updateBitmap();\n                break;\n            default:\n                console.log(\"Unknown event key: \" + data.key);\n        }\n    }\n}\n\ntype layerEventKey = \"setCanvas\" | \"drawDot\"\n\ninterface LayerWorkerEvent {\n    key: layerEventKey;\n    data: any;\n}\n\n\nexport class WorkerLayer {\n    private _bitmap: ImageBitmap;\n    private _worker: Worker;\n    private _size: Vec2;\n    private _offset: Vec2;\n\n    postMessage(e: LayerWorkerEvent, transfer?: Transferable[]) {\n        if (transfer !== undefined){\n            this._worker.postMessage(e, transfer);\n            return;\n        }\n        this._worker.postMessage(e, transfer);\n    }\n\n    get bitmap(): ImageBitmap {\n        return this._bitmap;\n    }\n\n    constructor(size: Vec2, offset: Vec2 = [0, 0]) {\n        this._size = size;\n        this._offset = offset;\n\n        this._worker = createWorkerFromFunction(layerWorkerCode);\n\n        this._worker.onmessage = (e) => {\n            let data = e.data ;\n            switch (data.key) {\n                case \"updateBitmap\":\n                    this._bitmap = data.data as ImageBitmap;\n                    break;\n                default:\n                    console.log(\"Unknown event key: \" + data.key);\n            }\n        }\n\n        let tmpCanvas = new OffscreenCanvas(size[0], size[1]);\n        let ctx = tmpCanvas.getContext(\"2d\") as OffscreenCanvasRenderingContext2D;\n        ctx.fillStyle = \"red\";\n        ctx.fillRect(0, 0, 100, 100);\n        this._bitmap = tmpCanvas.transferToImageBitmap();\n\n        let canvas = new OffscreenCanvas(size[0], size[1]);\n\n        this.postMessage(\n            {\n                key: \"setCanvas\",\n                data: canvas\n            }, [canvas]\n        );\n    }\n\n    drawDot(pos: Vec2) {\n        this.postMessage({\n            key: \"drawDot\",\n            data: pos\n        });\n    }\n}", "import {workerFunction} from \"./Worker\";\nimport {createWorkerFromFunction} from \"./submodules/common-ts-utils/WebWorker/CreateWorker\";\nimport {\n    CanvasUpdateEvent,\n    docManagerWorker,\n    DocWorkerEvent, ToolOpEvent,\n    ToolUpdateEvent\n} from \"./Documents/DocManager/DocManagerWorker\";\nimport {DotPen} from \"./PaintTools/DotPen\";\nimport {WorkerLayer} from \"./Documents/DocNodes/WorkerLayer\";\n\nconsole.log(\"Main.ts\");\n\n\nfunction main() {\n    let htmlCanvas = document.getElementById(\"canvas\") as HTMLCanvasElement;\n\n    let size:Vec2 = [2000, 2000];\n    let layer = new WorkerLayer(size);\n    htmlCanvas.width = size[0];\n    htmlCanvas.height = size[1];\n\n    let ctx = htmlCanvas.getContext(\"2d\") as CanvasRenderingContext2D;\n\n    function frameUpdate() {\n        ctx.clearRect(0, 0, htmlCanvas.width, htmlCanvas.height);\n        ctx.drawImage(layer.bitmap, 0, 0);\n        ctx.drawImage(layer.bitmap, 0, 0);\n        ctx.drawImage(layer.bitmap, 0, 0);\n        ctx.drawImage(layer.bitmap, 0, 0);\n        requestAnimationFrame(frameUpdate);\n    }\n    frameUpdate();\n    htmlCanvas.onpointermove = (event) => {\n        layer.drawDot([event.offsetX, event.offsetY]);\n    }\n\n\n    // let offscreenCanvas = htmlCanvas.transferControlToOffscreen();\n    //\n    // let worker = createWorkerFromFunction(docManagerWorker);\n    // worker.onmessage = (event) => {\n    //     console.log(\"Main.ts got message: \" + event.data);\n    // }\n    // let canvasEvent: CanvasUpdateEvent = {\n    //     canvas: offscreenCanvas\n    // }\n    //\n    // let docWorkerEvent: DocWorkerEvent = {\n    //     key: \"setCanvas\",\n    //     data: canvasEvent\n    // }\n    //\n    // worker.addEventListener(\"message\", (event) => {\n    //     console.log(\"Main.ts got message: \");\n    //     console.log(event.data);\n    //     console.log(event.origin);\n    // });\n    //\n    //\n    //\n    // worker.postMessage(docWorkerEvent, [offscreenCanvas]);\n    //\n    // function objectToStr(obj: any): string {\n    //     return obj[\"constructor\"].toString();\n    // }\n    //\n    // let pen = new DotPen();\n    //\n    // let penConstructorStr = objectToStr(pen);\n    //\n    // let toolEvent: ToolUpdateEvent = {\n    //     tool: penConstructorStr\n    // }\n    //\n    // console.log(penConstructorStr);\n    //\n    // docWorkerEvent = {\n    //     key: \"setTool\",\n    //     data: toolEvent\n    // }\n    //\n    // worker.postMessage(docWorkerEvent);\n    //\n    // docWorkerEvent = {\n    //     key: \"log\",\n    //     data: \"nothing\"\n    // }\n    // worker.postMessage(docWorkerEvent)\n    //\n    // function methodsToStringDict(method: any) {\n    //     let dict: any = {};\n    //     for (let key of Object.getOwnPropertyNames(Object.getPrototypeOf(method))) {\n    //         dict[key] = method[key].toString();\n    //     }\n    //     return dict;\n    // }\n    //\n    // // get all methods from pen\n    // let penDict = methodsToStringDict(pen);\n    // let methods = Object.getOwnPropertyNames(Object.getPrototypeOf(pen));\n    //\n    // console.log(pen[\"onMove\"].toString())\n    // console.log(penDict);\n    //\n    //\n    // htmlCanvas.addEventListener(\"pointermove\", (event) => {\n    //     let toolOpEvent: ToolOpEvent = {\n    //         event: {\n    //             pos: [event.offsetX, event.offsetY],\n    //             button: event.button,\n    //             type: \"move\",\n    //             pressure: event.pressure\n    //         }\n    //     }\n    //\n    //     docWorkerEvent = {\n    //         key: \"toolOp\",\n    //         data: toolOpEvent\n    //     }\n    //\n    //     worker.postMessage(docWorkerEvent);\n    // })\n    // docWorkerEvent = {\n    //     key: \"returnBitmap\",\n    //     data: \"nothing\"\n    // }\n    //\n    // worker.postMessage(docWorkerEvent)\n    //\n    // worker.addEventListener(\"message\", (event) => {\n    //     console.log(\"Main.ts got message: \");\n    //     if (event.data instanceof ImageBitmap) {\n    //         console.log(\"Main.ts got ImageBitmap\");\n    //         let newCanvas = document.createElement(\"canvas\");\n    //         newCanvas.width = event.data.width;\n    //         newCanvas.height = event.data.height;\n    //         let ctx = newCanvas.getContext(\"2d\") as CanvasRenderingContext2D;\n    //         ctx.drawImage(event.data, 0, 0);\n    //         document.body.appendChild(newCanvas);\n    //     }\n    // });\n\n    // let ctx = offscreenCanvas.getContext(\"2d\") as OffscreenCanvasRenderingContext2D;\n    // ctx.fillStyle = \"red\";\n    // ctx.fillRect(0,0,100,100);\n}\n\nmain()\n\nconsole.log(\"Main.ts done.\")\n"],
  "mappings": "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",
  "names": []
}
